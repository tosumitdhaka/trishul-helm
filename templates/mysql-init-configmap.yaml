apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "trishul.fullname" . }}-mysql-init
  labels:
    {{- include "trishul.labels" . | nindent 4 }}
data:
  init-databases.sh: |
    #!/bin/bash
    set -e
    {{- $configFile := .Files.Get "config/config.yaml" }}
    {{- $default := $configFile | fromYaml }}
    {{- $config := .Values.config | default dict }}
    
    echo "Creating Trishul databases..."
    
    mysql -uroot -p"${MYSQL_ROOT_PASSWORD}" <<-EOSQL
      CREATE DATABASE IF NOT EXISTS {{ $config.database.parser_db | default $default.database.parser_db }};
      CREATE DATABASE IF NOT EXISTS {{ $config.database.jobs_db | default $default.database.jobs_db }};
      CREATE DATABASE IF NOT EXISTS {{ $config.database.system_db | default $default.database.system_db }};
      CREATE DATABASE IF NOT EXISTS {{ $config.database.traps_db | default $default.database.traps_db }};
      
      GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' WITH GRANT OPTION;
      FLUSH PRIVILEGES;
    EOSQL
    
    echo "Databases created successfully!"
